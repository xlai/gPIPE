---
title: "Vignette: Constructors for PIPE Modelling"
output:
    bookdown::html_document2: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
path_to_source <- "./src/"
files_to_source <- list.files(path = path_to_source, pattern = '*.R')
sapply(files_to_source, function(x) source(paste0(path_to_source, x )))
```

## Introduction
This vignette demonstrates the use of five classes: 
`Drug`, `DrugCombination`, `PipeEstimator`, `PatientDataModel`, and `DrugCombinationModel`. 
These constructors are used for modelling different aspects of a clinical trial under PIPE design.

## Setup
First, we need to ensure that the `yaml` package is installed and loaded.

```{r pkg-setup, echo = TRUE}
if (!requireNamespace("yaml", quietly = TRUE)) {
    install.packages("yaml")
}
library(yaml)
```

### Reading dose information from a YAML file
```{r dose-levels, echo = TRUE}
drugData <- yaml::read_yaml("./src/doses.yaml")
print(drugData)
```

## Drug Class
he Drug class in R is designed to manage drug information, including its name and dose levels. 
It offers a versatile way of initializing drug data either from a structured input (like a YAML file) or programmatically with specified parameters.

We can create the object directly,
```{r, echo = TRUE}
num_doses <- 3
drugA <- createDrug(name = 'drugA', doseCount = num_doses)
```

or it can be created from YAML specifying dose label and their corresponding numerical level.
```{r, echo = TRUE}
drug_list <- createDrug(drugData = drugData)
```

Here are a few things that we can do with the classes:
### Get dose informations
```{r, echo = TRUE}
# Get dose labels for Drug1
drug_labels <- lapply(drug_list, function(d){d$getDoseLabels()})
print(drug1_labels)
# Get numeric order for dose 2 of DrugA
drugA = drug_list[[1]]
dose_levelA <- drugA$getDoseLevels("Medium")
print(dose_levelA)
```

### Add additional dose(s)
```{r, echo = TRUE}
# Assuming the DrugDose object is already created with some drugs and dose levels
# Add a new dose label to a drug
drugA$addDose(new_label = "Extra", new_level = 2)

# Get updated dose labels for Drug1
updated_labels <- drugA$getDoseLabels()
print(updated_labels)

# Get numeric order for the new label 'Extra'
extra_dose_order <- drugA$getDoseLevels("Extra")
print(extra_dose_order)

```

## `DrugCombi` Class

The DrugCombi class, short for Drug Combination, is designed for managing combinations of different drugs and their respective dose levels. 

It is a coomposite constructor of multiple drugs that gives additional methods that are 
uniquely defined for drug combinations

Assume we have a list of drug created using `Drug` class, the a `DrugCombi` object can be initialised as the following
```{r, echo = TRUE}
drugcombi_new <- DrugCombi$new(drugs =drug_list)
```

## PipeEstimator Constructor

Assuming the DrugCombi object (`drugcombi_new`) is already created. Let's create a PipeEstimator object
```{r, echo = TRUE}
pipe_estimator <- createPipeEstimator(drug_dose_obj, isNonDecreasing = TRUE)
# New configuration to set
newGamma <- list("Low", "d3")
# Manually update the configuration
pipe_estimator$updateConfiguration(newGamma)

# Example gamma configuration to check
gammaConfigs <- list(
    list("Low", "d1"),
    list("Low", "d4")
)
# Check if the configuration is valid
is_valid <- pipe_estimator$isValidConfiguration(gammaConfigs)
print(is_valid)
```

## PatientDataModel Constructor

Assuming `drug_dose_obj` is an instance of DrugDose with valid dose levels for each drug

Create a PatientDataModel object:
```{r, echo = TRUE}
patientDataModel <- createPatientDataModel(drugcombi_new)

# Add patient data with dose levels for each drug
patientDataModel$addPatientData(doseCombination = "Low-d1", outcome = 0)
patientDataModel$addPatientData(doseCombination = "Low-d2", outcome = 1)
# ...

# Get summary statistics for each dose level combination
summaryStats <- patientDataModel$getSummaryStats(includeAllCombi = FALSE)
print(summaryStats)

# Define maximum dose levels for each drug
maxDoseLevel <- "Medium-d3"

# Generate random patient data
patientDataModel$generateRandomPatientData(maxDoseLevel, numPatients = 10, outcomeProb = 0.3)

# View generated data
print(patientDataModel$patientData)

summaryStats <- patientDataModel$getSummaryStats(includeAllCombi = TRUE)
print(summaryStats)
```

## DrugCombinationModel Constructor
```{r, echo = TRUE}
# Create a DrugCombinationModel object
drugCombinationModel <- createDrugCombinationModel("./src/drugPrior.yaml")

# Update the model based on patient data
updatedModel <- drugCombinationModel$updateModel(patientDataModel)

# View updated model statistics
print(updatedModel)
```